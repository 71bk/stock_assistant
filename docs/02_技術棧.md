# 技術棧（投資助理平台）

> 本文件整理「目前定案」與「可選擴充」的技術選型，對齊專案架構書 v2 與我們討論內容。

---

## 1) 前端（Web SPA）
- **框架**：React 18
- **UI 組件庫**：Ant Design
- **狀態管理**：Zustand
- **路由**：React Router
- **建置工具**：Vite（建議搭配 TypeScript）
- **HTTP Client**：Axios（`withCredentials` 送 Cookie）
- **圖表**：TradingView Lightweight Charts / ECharts（擇一）
- **日期/時區**：dayjs（或 Luxon）  
  - 顯示依市場時區；後端與 DB 一律 **UTC** 存取

> 重點：前端不直打第三方股票 API，統一走後端 `/api/stocks/*` 代理。

---

## 2) 後端（Java / API Gateway + Domain Services）
- **語言 / 平台**：Java **17+**（Spring Boot 3 相容）
- **框架**：Spring Boot 3（Maven Multi-Module）
- **Web**：Spring Web (REST)
- **安全**：Spring Security
  - **Google-only 登入**（OAuth2 / OpenID Connect）
  - **JWT Access/Refresh**：HttpOnly Cookie
  - **Refresh Session 狀態**：Redis（撤銷 / 旋轉 / 防重放）
- **串流回覆**：SSE（AI 分析文字串流；v1 優先）
- **API 文件**：springdoc-openapi（Swagger UI）
- **模組化（核心）**
  - `app-auth`：Google login / JWT / users
  - `app-portfolio`：trades / positions（加權平均成本）
  - `app-stocks`：股票 API proxy + Redis cache + rate limit + instruments 主檔
  - `app-ocr`：OCR jobs / draft trades / 匯入管線
  - `app-ai`：SSE + prompt 管理 + report
  - `app-rag`：chunk/embedding + TopK 檢索 + citations
  - `app-files`：檔案上傳 + Object Storage（local/S3/MinIO）
  - `app-common`：ApiResponse、ErrorCode、Exception、Clock/Id…
  - `app-persistence`：資料存取配置、migration

---

## 3) 資料存取（Persistence）
- **主資料庫**：PostgreSQL 15+（建議）
  - `schema: app`：業務資料（users / trades / positions / files / ocr / reports…）
  - `schema: vector`：RAG 向量資料（pgvector）
  - **JSONB**：OCR 解析結果、AI input/output summary、errors/warnings…
- **向量擴充**：pgvector（embedding vector(n)）
- **Migration**：Flyway（建議，用於 DDL 版本控管）
- **ORM/Query 選型（建議組合）**
  - JPA/Hibernate：auth/users 這類相對單純的 entity
  - MyBatis-Plus：大量 CRUD / 分頁列表
  - 手寫 SQL：pgvector / JSONB 深度查詢與效能關鍵處

---

## 4) Cache / Session / Queue（Redis）
- **Redis**：
  - 行情快取（quote / candles，短 TTL）
  - Rate limit（依 user / IP / endpoint）
  - OCR/AI job 狀態（短期）
  - Refresh token session（`sess:refresh:{jti}`，撤銷與旋轉）
- **（可選）Redis Streams**
  - `ocr:queue` / `ingest:queue`：AI Worker 非同步處理
  - Consumer Group + retry / dedupe（以 `sha256` 等做冪等）

---

## 5) 股票行情與多市場（TW + US）
- **後端代理第三方 Stock API**
  - 封裝成 `StockMarketClient` Port（可替換供應商）
  - Redis cache + rate limit + 回傳格式正規化（quote/candles）
- **商品主檔（Instrument Master）**
  - `instrument_id`（UUID）作為內部主鍵
  - `symbol_key = {market}:{exchange}:{ticker}`（例：`US:XNAS:AAPL`、`TW:TWSE:2330`）
  - `instrument_aliases` 支援 ticker 變體（BRK.B / BRK-B）
- **幣別/匯率**
  - `fx_rates` 支援 USD/TWD
  - 使用者設定 `base_currency`（預設 TWD）統一換算顯示

---

## 6) OCR 匯入交易（Draft → Review → Confirm）
- **流程**
  1. Upload（image/pdf）→ `files`
  2. OCR + AI Parse → 產出 **draft trades**
  3. OCR Review 頁：使用者可編輯/勾選/確認
  4. Confirm 才寫入 `stock_trades` 並更新 `user_positions`
- **資料模型**
  - `ocr_jobs` / `ocr_results` / `ocr_draft_trades`
  - 或採用 `statements / statement_*` staging 管線（OCR & 手動輸入共用）
- **民國轉西元（ROC → AD）**
  - DB 一律存西元 `DATE/TIMESTAMP`
  - 匯入解析支援 `YYYMMDD`：西元年 = 民國年 + 1911（必要時寫 warnings）

---

## 7) AI 分析 + RAG（pgvector）
- **LLM Provider**：可插拔（`LlmClient` Port）
  - 用於行情摘要、持股成本解讀、結構化解析（parsed_json）等
- **Streaming**：SSE（server → client）
- **RAG**：
  - 文件/快照/筆記/報告 → chunking → embedding → 寫入 pgvector
  - Chat/分析時 TopK 檢索並回傳 citations
- **Embedding Provider**：可插拔（`EmbeddingClient` Port）
- **Vector Store**：pgvector（`VectorStore` Port）

---

## 8) （可選）Python AI Worker（OCR / Ingestion / 回測）
> 不改變主線 Java 架構，把影像/文件/批次處理抽成獨立服務。

- **框架**：Python + FastAPI
- **能力（建議用在）**
  - OCR 前處理（去噪/裁切/旋轉/表格結構還原）
  - 文件 ingestion（PDF/HTML/Docx 清理、chunking、批次 embedding）
  - 回測/指標計算（pandas/numpy 生態）
- **互動方式**
  - 同步：Backend 直接呼叫 `/ocr`、`/ingest`
  - 非同步：Backend 寫 job → Redis Streams → Worker 消費 → 回寫 PG / 更新狀態

---

## 9) 檔案儲存（Object Storage）
- **Dev**：Local filesystem
- **Prod**：MinIO（自架 S3 相容）或 AWS S3
- **模式**
  - 一律先落 `app.files`（含 sha256/size/content_type）
  - 其他表只存 `file_id`
  - 可用 signed URL 讓前端直傳（省後端流量）

---

## 10) 反向代理 / 部署 / CI/CD
- **容器化**：Docker
- **本機/單機編排**：Docker Compose（backend + postgres(pgvector) + redis +（可選）ai-worker + nginx）
- **反向代理**：Nginx
  - SSE：`proxy_buffering off`、調整 `proxy_read_timeout`
- **CI/CD**：GitHub Actions
  - CI：build/test
  - Deploy：build image → push registry → SSH 到主機 → `docker compose pull && docker compose up -d`
- **部署目標**：任一支援 Docker 的主機（EC2/VM/K8s 皆可）

---

## 11) 可觀測性（建議）
- **Logging**：SLF4J + Logback（JSON log 可選）
- **Metrics**：Micrometer + Prometheus / Grafana（可選）
- **Tracing**：OpenTelemetry（可選）
- **Error Tracking**：Sentry（可選）

---

## 12) 測試（建議）
- **後端**：JUnit 5、Spring Boot Test
- **整合測試**：Testcontainers（Postgres/Redis）
- **前端 E2E**：Playwright（或 Cypress）

---

## 13) 安全與跨網域（定案重點）
- **Cookie-based auth**
  - `access_token`：短效（5~15 分）HttpOnly/Secure
  - `refresh_token`：長效（7~30 天）HttpOnly/Secure，Path 限縮到 `/api/auth/refresh`
- **CORS**：白名單 origin + `allowCredentials=true`
- **Refresh Rotation**：每次 refresh 產生新 refresh，舊 refresh 立刻在 Redis 失效
- **網域建議**：前端 `app.xxx.com`、後端 `api.xxx.com`，避免 Cookie 汙染其他子站

---

## 14) 選型總覽（TL;DR）
- **Frontend**：React + Ant Design + Vite + Axios + Chart lib
- **Backend**：Spring Boot 3 (Multi-Module) + Spring Security + SSE
- **DB**：PostgreSQL + JSONB + pgvector
- **Cache/Session/Queue**：Redis（含 rate limit / refresh session / streams 可選）
- **AI**：LLM + Embeddings（Port/Adapter 可替換）+ RAG（pgvector）
- **OCR**：Java 直連或（推薦）Python FastAPI Worker
- **Infra**：Docker Compose + Nginx + GitHub Actions



