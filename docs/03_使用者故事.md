# 使用者故事（投資助理平台）

> 目的：用「使用者角度」描述功能需求，方便跟客戶/利害關係人對齊範圍與優先順序。  
> 標記：**MVP**（先做）、**v1**（第一輪補齊）、**v2+**（進階/可選）。

---

## 0. 角色定義（Roles）
- **訪客**：尚未登入的使用者
- **使用者（投資人）**：已登入，管理自己的投資紀錄/持倉/報告
- **管理員（營運）**：維護商品主檔、處理異常匯入、監控系統狀態（可選）

---

## 1. 註冊 / 登入（Google-only）
### US-1 訪客用 Google 登入
**身為** 訪客，我想用 Google 帳號登入，**以便** 直接使用平台且降低註冊成本。  
**優先**：MVP  
**驗收條件**
- 點擊「Google 登入」可完成 OAuth2 流程並回到前端
- 登入成功後取得有效 session（access/refresh token 以 HttpOnly Cookie）
- 後端可建立/更新使用者資料（email、name、avatar）

### US-2 使用者可登出並撤銷當前裝置登入狀態
**身為** 使用者，我想登出，**以便** 避免他人使用我的帳號。  
**優先**：MVP  
**驗收條件**
- 登出後 access cookie 失效，refresh session 被撤銷
- 重新整理頁面會回到未登入狀態

### US-3 使用者可查看與管理登入裝置/工作階段
**身為** 使用者，我想查看已登入的裝置/工作階段並可逐一撤銷，**以便** 控管帳號安全。  
**優先**：v1  
**驗收條件**
- 列表顯示：最近活動時間、裝置/瀏覽器、IP（可選）
- 可撤銷某一個 session，該裝置下次操作需重新登入

---

## 2. 商品主檔（台股 + 美股）
### US-4 系統能以「商品唯一鍵」辨識同一檔股票
**身為** 使用者，我希望同一檔股票在系統中有唯一識別，**以便** 匯入/查詢/分析一致。  
**優先**：MVP  
**驗收條件**
- 股票資料以 `instrument_id` 為主鍵
- 以 `symbol_key = {market}:{exchange}:{ticker}` 做唯一約束（如 `US:XNAS:AAPL`、`TW:TWSE:2330`）
- 支援別名（例如 `BRK.B` 與 `BRK-B`）

### US-5 使用者可用代號或名稱搜尋股票
**身為** 使用者，我想用代號/名稱快速搜尋股票，**以便** 建立持股或查行情。  
**優先**：MVP  
**驗收條件**
- 支援模糊搜尋（包含 alias）
- 顯示市場（TW/US）、交易所、幣別

---

## 3. 行情/圖表（Quote / Candles）
### US-6 使用者可查看單一股票即時報價與基本資訊
**身為** 使用者，我想看即時報價與漲跌資訊，**以便** 了解市場狀態。  
**優先**：MVP  
**驗收條件**
- 顯示：現價、漲跌、成交量（供應商有提供則顯示）
- 市場狀態顯示（開盤/收盤/盤前盤後，若資料來源支援）

### US-7 使用者可查看 K 線圖並切換區間
**身為** 使用者，我想看 K 線圖並切換 1D/1W/1M/1Y，**以便** 快速判斷趨勢。  
**優先**：MVP  
**驗收條件**
- 至少提供 1D、1M、1Y（區間可依供應商調整）
- X 軸時間顯示符合市場時區；後端與 DB 仍以 UTC 存

### US-8 使用者可在圖表頁一鍵觸發 AI 行情摘要
**身為** 使用者，我想在圖表頁一鍵請 AI 產生摘要，**以便** 快速理解近期走勢與風險點。  
**優先**：v1  
**驗收條件**
- 以 SSE 串流顯示生成內容（逐字/逐段）
- 生成完成後可保存為報告（可選）

---

## 4. 投資組合（交易 / 持倉 / 成本）
### US-9 使用者可手動新增一筆交易
**身為** 使用者，我想手動新增買/賣交易，**以便** 管理我的投資紀錄。  
**優先**：MVP  
**驗收條件**
- 必填：股票、買/賣、日期、數量、價格、手續費/稅（可選）
- 儲存後會更新持倉（股數、均價/成本）

### US-10 使用者可查看某檔股票的交易明細
**身為** 使用者，我想查看交易明細，**以便** 追溯操作與績效。  
**優先**：MVP  
**驗收條件**
- 可依時間排序/篩選（起訖日）
- 可編輯/刪除單筆交易（刪除會回算持倉）

### US-11 使用者可查看我的持倉列表與損益
**身為** 使用者，我想看到持倉列表與未實現損益，**以便** 掌握整體部位。  
**優先**：v1  
**驗收條件**
- 顯示：持股數、成本（均價/總成本）、現價、市值、損益
- 支援排序（損益/市值/成本）

### US-12 支援多幣別資產，並可切換顯示基準幣別
**身為** 使用者，我想把 USD/TWD 等資產統一換算到我的基準幣別，**以便** 看懂總資產。  
**優先**：v1  
**驗收條件**
- 使用者可設定 base currency（預設 TWD）
- 美股持倉以匯率換算顯示（匯率資料可由後端供應）

---

## 5. OCR 匯入交易（Draft → Review → Confirm）
### US-13 使用者可上傳對帳單/成交明細截圖或 PDF
**身為** 使用者，我想上傳文件讓系統幫我轉成交易，**以便** 減少手動輸入。  
**優先**：MVP  
**驗收條件**
- 支援圖片（JPG/PNG）與 PDF（至少其一）
- 上傳後產生一筆 OCR Job 並顯示處理中狀態

### US-14 系統可產生「交易草稿」並提示不確定欄位
**身為** 使用者，我想 OCR 後直接看到可編輯的交易草稿，**以便** 快速確認正確性。  
**優先**：MVP  
**驗收條件**
- 產出 draft trades（多筆）
- 每筆草稿標示解析信心度/警告（如缺少手續費、日期格式不明）

### US-15 使用者可在 Review 頁逐筆修正草稿
**身為** 使用者，我想在確認前修正草稿欄位，**以便** 避免錯誤入帳。  
**優先**：MVP  
**驗收條件**
- 可修改：股票、買賣、日期、數量、價格、費用、幣別
- 可勾選要匯入的筆數／刪除不要的草稿

### US-16 使用者確認後才會寫入正式交易與更新持倉
**身為** 使用者，我想按下確認後才正式入帳，**以便** 保持資料可信。  
**優先**：MVP  
**驗收條件**
- Confirm 前不影響正式持倉
- Confirm 後寫入交易表並更新持倉，顯示成功結果與匯入筆數

### US-17 OCR 可自動把民國日期轉換成西元
**身為** 使用者，我希望系統能把民國日期自動轉成西元，**以便** 減少手動校正。  
**優先**：MVP（若目標客群以台灣券商為主）  
**驗收條件**
- 偵測到民國格式（例：`112/03/15`）可轉 `2023-03-15`
- 轉換後仍保留原始文字（可選：供稽核）
- 若無法判斷，會提示使用者確認

---

## 6. AI 助理（聊天 / 解析 / 報告）
### US-18 使用者可針對投資組合提問並得到建議型解讀
**身為** 使用者，我想問「我這檔成本多少、為什麼虧損」，**以便** 理解自己的部位。  
**優先**：v1  
**驗收條件**
- 以 SSE 串流回覆
- 可引用系統內資料（交易/持倉）做解釋（不編造不存在的交易）

### US-19 AI 回覆可附上引用來源（citaions）
**身為** 使用者，我想看到 AI 回覆引用了哪些資料來源，**以便** 信任與追溯。  
**優先**：v1  
**驗收條件**
- 若使用 RAG，回覆含 citations（文件/段落/時間）
- 點擊 citations 可開啟對應內容（前端可先以 modal 顯示節錄）

### US-20 使用者可保存 AI 報告並在歷史報告中回看
**身為** 使用者，我想把 AI 產出的分析保存，**以便** 之後比較與追蹤。  
**優先**：v1  
**驗收條件**
- 報告可命名、可查列表、可查看詳細內容
- 報告綁定觸發當下的股票/組合範圍與時間（避免日後混淆）

---

## 7. 知識庫 / 長期記憶（RAG Ingestion）
### US-21 使用者可上傳文件/筆記建立個人知識庫
**身為** 使用者，我想上傳研究報告/筆記，**以便** AI 回答更貼近我的策略。  
**優先**：v1  
**驗收條件**
- 可上傳並建立文件記錄（標題、來源、標籤）
- 文件會被切 chunk 並寫入向量庫（後台處理即可）

### US-22 使用者可搜尋我的文件與片段
**身為** 使用者，我想搜尋文件內容，**以便** 快速找到我過去的紀錄。  
**優先**：v1  
**驗收條件**
- 支援關鍵字搜尋（先做）
- 支援語意搜尋（RAG TopK）（進階）

---

## 8. 公司行為（Corporate Actions）
### US-23 系統可處理股票分割/反分割造成的股數與成本調整
**身為** 使用者，我想在分割/反分割後仍能正確看到股數與成本，**以便** 持倉不被算錯。  
**優先**：v2+  
**驗收條件**
- 可記錄 corporate action（effective date、ratio）
- 回算影響的持倉數量與成本顯示（至少提供提示與調整機制）

### US-24 支援股利紀錄與收益統計
**身為** 使用者，我想記錄股利並看到收益統計，**以便** 評估投資回報。  
**優先**：v2+  
**驗收條件**
- 可新增股利事件（日期、幣別、金額）
- 可在報表看到期間股利總額（以基準幣別換算）

---

## 9. 提醒 / 通知
### US-25 使用者可設定價格提醒（到價通知）
**身為** 使用者，我想設定到價提醒，**以便** 不必一直盯盤。  
**優先**：v2+  
**驗收條件**
- 支援「高於/低於某價格」
- 觸發後可推送（站內通知/Email/LINE 可選）

---

## 10. 設定 / 偏好 / 資料匯出
### US-26 使用者可設定時區、基準幣別與顯示偏好
**身為** 使用者，我想設定顯示偏好，**以便** 資訊符合我的習慣。  
**優先**：v1  
**驗收條件**
- 可設定 base currency（TWD/USD）
- 時區僅影響顯示；後端統一 UTC

### US-27 使用者可匯出交易資料（CSV）
**身為** 使用者，我想匯出交易資料，**以便** 自行備份或做其他分析。  
**優先**：v2+  
**驗收條件**
- 可選日期區間匯出
- 匯出檔案包含：股票、買賣、日期、數量、價格、費用、幣別

---

## 11. 管理端（可選）
### US-28 管理員可維護商品主檔與別名
**身為** 管理員，我想維護 ticker/別名，**以便** OCR 與搜尋更準。  
**優先**：v2+  
**驗收條件**
- 可新增/修改/停用 instrument
- 可管理 aliases 與 symbol_key 唯一性

### US-29 管理員可查看 OCR 失敗案例與重跑
**身為** 管理員，我想查看 OCR 失敗原因並重跑，**以便** 降低使用者流失。  
**優先**：v2+  
**驗收條件**
- 可查看 job 狀態與錯誤訊息
- 可觸發重試/重新解析（具冪等控制）

---

## 12. 非功能性需求（NFR）— 同樣用故事方式描述
### NFR-1 資料一致性：確認前不影響正式帳
**身為** 使用者，我希望在我按下「確認匯入」之前，正式交易與持倉不會被改動。  
**優先**：MVP  
**驗收條件**
- draft 與正式交易分表或分狀態
- Confirm 才產生正式交易與持倉更新

### NFR-2 安全：Cookie-based JWT 與 Refresh Rotation
**身為** 使用者，我希望登入狀態安全且可控，**以便** 避免被盜用。  
**優先**：MVP  
**驗收條件**
- access/refresh 使用 HttpOnly/Secure Cookie
- refresh 旋轉：每次 refresh 會使舊 refresh 失效
- 可撤銷 refresh session

### NFR-3 效能：行情查詢需快且可被快取
**身為** 使用者，我希望行情載入快速，**以便** 使用體驗順暢。  
**優先**：MVP  
**驗收條件**
- 熱門行情具快取（短 TTL）
- 超過速率限制時給出明確提示（稍後再試）

---

## 13. MVP 功能清單（對齊上面故事）
- Google 登入（US-1 ~ US-2）
- 股票搜尋（US-4 ~ US-5）
- 基礎行情/圖表（US-6 ~ US-7）
- 手動交易 + 基礎持倉回算（US-9 ~ US-10）
- OCR 上傳 → 草稿 → Review → Confirm（US-13 ~ US-17）
- 基本安全與一致性（NFR-1 ~ NFR-2）

---

## 14. 後續版本建議（v1 / v2+）
- **v1**：持倉損益（US-11）、多幣別換算（US-12）、AI 助理 + citations + 報告（US-18 ~ US-20）、個人知識庫（US-21 ~ US-22）
- **v2+**：公司行為/股利（US-23 ~ US-24）、提醒通知（US-25）、匯出（US-27）、管理端（US-28 ~ US-29）

